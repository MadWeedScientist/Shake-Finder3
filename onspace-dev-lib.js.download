!function(){"use strict";var e;e=function(){const e=Object.defineProperty,setProperty=(t,n,i)=>{const s="symbol"!=typeof n?n+"":n;return n in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i},t=new class{constructor(){setProperty(this,"currentTargetWindow"),setProperty(this,"handlers",{}),setProperty(this,"pending"),this.pending=new Map,this.listen()}get targetWindow(){if("undefined"!=typeof window)return window.parent}get targetOrigin(){return this.currentTargetWindow?this.currentTargetWindow:"*"}allowOrigin(e){return[/onspace\.ai/,/suanshubang\.cc/,/localhost|127\.0\.0\.1/,/ons\./,/10\.250\.25\.1/].some((t=>t.test(e)))}setTarget(e){this.currentTargetWindow=e.origin}sendEvent(e,t=3,n=1e3){const i=Date.now()+Math.random().toString(36).substring(2),s={id:i,...e},attemptSend=(e=0)=>{const a=this.targetWindow;a&&a.postMessage(s,this.targetOrigin);const r=n*Math.pow(2,e),l=setTimeout((()=>{e>=t?this.pending.delete(i):attemptSend(e+1)}),r);this.pending.set(i,{timer:l,attempt:e})};attemptSend()}listen(){window.addEventListener("message",(e=>{var t;this.allowOrigin(e.origin)&&(null==(t=e.data)?void 0:t.event)&&(e.data.id||e.data.originalId)&&(this.currentTargetWindow||this.setTarget({origin:e.origin}),"ack"===e.data.event?this.handleAckMessage(e.data):this.handleRegularMessage(e))}))}handleAckMessage(e){const{originalId:t}=e,n=this.pending.get(t);n&&(clearTimeout(n.timer),this.pending.delete(t))}handleRegularMessage(e){const t=this.targetWindow;t&&t.postMessage({event:"ack",originalId:e.data.id},e.origin);const n=this.handlers[e.data.event];n&&n.call(this.handlers,e.data.data)}onEvent(e,t){this.handlers[e]=t}};class BaseOverlay{constructor(){setProperty(this,"container"),setProperty(this,"target",null),setProperty(this,"visible",!1),setProperty(this,"BORDER_WIDTH",1),setProperty(this,"resizeObserver"),setProperty(this,"mutationObserver"),setProperty(this,"updatePosition",this.createThrottledUpdate()),this.initializeContainer(),this.setupObservers()}initializeContainer(){this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.pointerEvents="none",this.container.style.zIndex="9999"}createThrottledUpdate(){let e=!1;return()=>{!e&&this.target&&(this.performPositionUpdate(),e=!0,setTimeout((()=>e=!1),16))}}performPositionUpdate(){const e=this.target.getBoundingClientRect(),t=window.getComputedStyle(this.target);this.container.style.boxSizing="content-box",this.container.style.top=e.top+window.scrollY-this.BORDER_WIDTH+"px",this.container.style.left=e.left+window.scrollX-this.BORDER_WIDTH+"px",this.container.style.width=`${e.width}px`,this.container.style.height=`${e.height}px`,this.container.style.borderRadius=t.borderRadius}setupObservers(){this.resizeObserver=new ResizeObserver(this.updatePosition),this.mutationObserver=new MutationObserver(this.updatePosition),window.addEventListener("resize",this.updatePosition)}show(e){var t,n;this.target=e,this.updatePosition(),document.body.appendChild(this.container),this.visible=!0,this.target&&(null==(t=this.resizeObserver)||t.observe(this.target),null==(n=this.mutationObserver)||n.observe(this.target,{attributes:!0,childList:!0,subtree:!0}))}cleanup(){var e,t,n;this.target&&(null==(e=this.resizeObserver)||e.unobserve(this.target)),this.container.remove(),this.target=null,this.visible=!1,null==(t=this.resizeObserver)||t.disconnect(),null==(n=this.mutationObserver)||n.disconnect(),window.removeEventListener("resize",this.updatePosition)}isVisible(){return this.visible}getTarget(){return this.target}}class HoverOverlay extends BaseOverlay{constructor(){super(),this.container.className="editor-hover-overlay",this.container.style.border="1px dashed #DEFF96",this.container.style.backgroundColor="rgba(222,255,150,0.15)"}}class SelectionOverlay extends BaseOverlay{constructor(){super(),setProperty(this,"tagElement"),this.container.className="editor-selection-overlay",this.container.style.border="2px dashed #DEFF96",this.container.style.backgroundColor="rgba(222,255,150,0.2)",this.createTagElement()}createTagElement(){this.tagElement=document.createElement("div"),this.tagElement.className="editor-element-tag",this.tagElement.style.position="absolute",this.tagElement.style.top="-34px",this.tagElement.style.left="-2px",this.tagElement.style.padding="2px 8px",this.tagElement.style.backgroundColor="#DEFF96",this.tagElement.style.color="#000",this.tagElement.style.borderRadius="6px",this.container.appendChild(this.tagElement)}show(e){super.show(e),this.tagElement.textContent=e.tagName.toLowerCase()}}class ElementDecorator{constructor(e){setProperty(this,"element"),setProperty(this,"overlay"),setProperty(this,"onChange"),this.element=e,this.overlay=new SelectedElementOverlay,this.overlay.show(this.element)}handleElement(){}cleanup(){this.overlay.cleanup()}}class SelectedElementOverlay extends SelectionOverlay{constructor(){super()}}function generateXPath(e){if(!e||e.nodeType!==Node.ELEMENT_NODE)return"";if(e.id&&1===document.querySelectorAll(`#${CSS.escape(e.id)}`).length)return`//*[@id="${e.id}"]`;const t=[];for(;e&&e.nodeType===Node.ELEMENT_NODE;){let n=1,i=e.previousElementSibling;for(;i;)i.nodeName===e.nodeName&&n++,i=i.previousElementSibling;const s=`${e.nodeName.toLowerCase()}${n>1?`[${n}]`:""}`;t.unshift(s),e=e.parentElement}return"/"+t.join("/")}class ElementSelector{constructor(){setProperty(this,"hoverOverlay"),setProperty(this,"selectedElement",null),setProperty(this,"selectedDecorator",null),setProperty(this,"isDirectEditing",!1),setProperty(this,"originalContent",""),setProperty(this,"handleMouseOver",this.createMouseOverHandler()),setProperty(this,"handleMouseOut",this.createMouseOutHandler()),setProperty(this,"handleClick",this.createClickHandler()),setProperty(this,"preventDefault",this.createPreventDefaultHandler()),setProperty(this,"handleInput",this.createInputHandler()),setProperty(this,"handleBlur",this.createBlurHandler()),this.hoverOverlay=new HoverOverlay,this.bindEvents()}isDirectlyEditable(e){return!!["P","SPAN","H1","H2","H3","H4","H5","H6","STRONG","EM","B","I","U","LABEL","BUTTON","A","DIV","LI","TD"].includes(e.tagName)&&Array.from(e.childNodes).every((e=>e.nodeType===Node.TEXT_NODE))}getElementType(e){return"IMG"===e.tagName?"image":this.isDirectlyEditable(e)?"text":"container"}createMouseOverHandler(){return e=>{const t=e.target;this.selectedElement&&t===this.selectedElement||this.hoverOverlay.show(t)}}createMouseOutHandler(){return e=>{this.hoverOverlay.cleanup()}}createClickHandler(){return e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.selectedElement!==t&&this.selectElement(t)}}selectElement(e){this.clearSelection(),this.selectedElement=e,this.selectedDecorator=function(e){return new ElementDecorator(e)}(e),this.hoverOverlay.cleanup();const t=this.getElementType(e);"text"===t&&this.enableDirectEditing(e),this.sendSelectedElementInfo(e,t)}enableDirectEditing(e){this.isDirectEditing=!0,this.originalContent=e.textContent,e.setAttribute("contenteditable","true"),e.focus(),e.addEventListener("input",this.handleInput),e.addEventListener("blur",this.handleBlur)}disableDirectEditing(e){e&&(this.isDirectEditing=!1,e.removeAttribute("contenteditable"),e.removeEventListener("input",this.handleInput),e.removeEventListener("blur",this.handleBlur))}createInputHandler(){return e=>{this.selectedElement&&this.isDirectEditing&&t.sendEvent({event:"edit_text_change",data:{xpath:generateXPath(this.selectedElement),content:e.target.textContent,originalContent:this.originalContent}})}}createBlurHandler(){return e=>{this.selectedElement&&this.isDirectEditing&&t.sendEvent({event:"edit_text_complete",data:{xpath:generateXPath(this.selectedElement),content:e.target.textContent,originalContent:this.originalContent}})}}sendSelectedElementInfo(e,n){const i={urlPath:window.location.pathname,xpath:generateXPath(e),outerHtml:e.outerHTML.length<800?e.outerHTML:"",tagName:e.tagName.toLowerCase(),elementType:n,className:e.className||"",textContent:"text"===n?e.textContent:"",src:"image"===n?e.src:"",isDirectlyEditable:"text"===n,isLink:"A"===e.tagName,href:e.getAttribute("href")||""};t.sendEvent({event:"edit_select_element",data:{element:i}})}clearSelection(){this.selectedElement&&this.disableDirectEditing(this.selectedElement),this.selectedDecorator&&(this.selectedDecorator.cleanup(),this.selectedDecorator=null),this.selectedElement=null,this.originalContent=""}createPreventDefaultHandler(){return e=>{(!this.isDirectEditing||"keydown"!==e.type&&"keyup"!==e.type&&"input"!==e.type)&&(e.preventDefault(),e.stopPropagation())}}bindEvents(){document.addEventListener("mouseover",this.handleMouseOver),document.addEventListener("mouseout",this.handleMouseOut),document.addEventListener("click",this.handleClick,!0),document.addEventListener("submit",this.preventDefault,!0),document.addEventListener("touchstart",this.preventDefault,!0),document.addEventListener("touchend",this.preventDefault,!0),t.onEvent("edit_update_className",(e=>{this.handleClassNameUpdate(e)})),t.onEvent("edit_update_image_src",(e=>{this.handleImageSrcUpdate(e)})),t.onEvent("edit_update_text_content",(e=>{this.handleTextContentUpdate(e)})),t.onEvent("edit_delete_element",(e=>{this.handleElementDelete(e)})),t.onEvent("edit_update_href",(e=>{this.handleHrefUpdate(e)})),t.onEvent("edit_cancel_selection",(e=>{this.clearSelection()}))}handleClassNameUpdate(e){this.selectedElement&&generateXPath(this.selectedElement)===e.xpath&&(this.selectedElement.className=e.className||"",t.sendEvent({event:"edit_update_success",data:{type:"className",xpath:e.xpath,value:e.className}}))}handleImageSrcUpdate(e){this.selectedElement&&generateXPath(this.selectedElement)===e.xpath&&"IMG"===this.selectedElement.tagName&&(this.selectedElement.src=e.src||"",t.sendEvent({event:"edit_update_success",data:{type:"imageSrc",xpath:e.xpath,value:e.src}}))}handleTextContentUpdate(e){this.selectedElement&&generateXPath(this.selectedElement)===e.xpath&&this.isDirectlyEditable(this.selectedElement)&&e.content!==this.selectedElement.textContent&&(this.selectedElement.textContent=e.content,t.sendEvent({event:"edit_update_success",data:{type:"textContent",xpath:e.xpath,value:e.content}}))}handleElementDelete(e){if(!this.selectedElement||generateXPath(this.selectedElement)!==e.xpath)return;const n=this.selectedElement;this.clearSelection(),n.remove(),t.sendEvent({event:"edit_delete_success",data:{xpath:e.xpath}})}handleHrefUpdate(e){this.selectedElement&&generateXPath(this.selectedElement)===e.xpath&&"A"===this.selectedElement.tagName&&(this.selectedElement.setAttribute("href",e.href||""),t.sendEvent({event:"edit_update_success",data:{type:"href",xpath:e.xpath,value:e.href}}))}cleanup(){var e;document.removeEventListener("mouseover",this.handleMouseOver),document.removeEventListener("mouseout",this.handleMouseOut),document.removeEventListener("click",this.handleClick,!0),document.removeEventListener("submit",this.preventDefault,!0),document.removeEventListener("touchstart",this.preventDefault,!0),document.removeEventListener("touchend",this.preventDefault,!0),null==(e=this.hoverOverlay)||e.cleanup(),this.clearSelection()}}const n=new class{constructor(){setProperty(this,"manager",null),setProperty(this,"style",null)}setEnabled(e){e?this.manager||(this.initializeStyles(),this.manager=new ElementSelector):this.destroy()}initializeStyles(){this.style||(this.style=document.createElement("style"),this.style.textContent="\n                    * {\n                        caret-color: #FF5530;\n                    }\n\n                    [contenteditable] {\n                        outline: 0px solid transparent;\n                    }\n                ",document.head.appendChild(this.style))}destroy(){this.style&&(this.style.remove(),this.style=null),this.manager&&(this.manager.cleanup(),this.manager=null)}},i=new class{constructor(){setProperty(this,"currentURL","")}init(){t.onEvent("navigation_control",this.handleNavigationControl.bind(this)),this.initURLChangeDetection()}handleNavigationControl(e){switch(e.action){case"back":window.history.back();break;case"forward":window.history.forward();break;case"refresh":window.location.reload()}}initURLChangeDetection(){this.currentURL=document.location.href;const e=document.querySelector("body");this.sendNavigationState();const t=new MutationObserver((()=>{this.currentURL!==document.location.href&&(this.currentURL=document.location.href,this.sendNavigationState(),this.sendNavigationState())}));e&&t.observe(e,{childList:!0,subtree:!0})}sendNavigationState(){const e=null==window?void 0:window.navigation,n={canGoBack:(null==e?void 0:e.canGoBack)??!0,canGoForward:(null==e?void 0:e.canGoForward)??!0,currentUrl:document.location.href};t.sendEvent({event:"navigation_state",data:n})}};new class{constructor(){setProperty(this,"isDocumentLoaded",!1),setProperty(this,"isEditingEnabled",!1),i.init(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>this.onDocumentLoaded())):this.onDocumentLoaded()}onDocumentLoaded(){this.isDocumentLoaded=!0,t.sendEvent({event:"request_config"}),t.onEvent("config_update",(e=>{this.isEditingEnabled=!!e.canEdit,e.selectedElement&&e.selectedElement.xpath&&setTimeout((()=>{this.initializeSelectedElement(e.selectedElement)}),100),this.updateEditingState()})),this.updateEditingState()}initializeSelectedElement(e){if(!this.isEditingEnabled||!e.xpath)return;const t=function(e){try{return document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(t){return null}}(e.xpath);t&&n.manager&&n.manager.selectElement(t)}updateEditingState(){const e=this.isEditingEnabled&&this.isDocumentLoaded;n.setEnabled(e)}}},"function"==typeof define&&define.amd?define(e):e()}();
